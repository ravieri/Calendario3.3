<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio de Partidas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.bundle.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        body.loaded {
            opacity: 1;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .calendar-day {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .calendar-day.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .filter-item, .nav-item {
             opacity: 0;
            transform: translateX(-20px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .filter-item.visible, .nav-item.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .calendar-day.has-events { cursor: pointer; background-color: #1f2937; }
        .calendar-day.has-events:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(79, 70, 229, 0.5); z-index: 10; }
        .calendar-day.today { border: 2px solid #4f46e5; }

        #day-details-panel { transition: transform 0.3s ease-in-out; transform: translateX(100%); z-index: 50; }
        #day-details-panel.open { transform: translateX(0); }

        #sidebar { transition: transform 0.3s ease-in-out, width 0.3s ease-in-out; z-index: 40; }
        #sidebar.collapsed { transform: translateX(-100%); width: 0; padding: 0; }
        
        #calendar-background-particles {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            max-width: 1000px;
            max-height: 600px;
            z-index: 0;
            border-radius: 50%;
        }

        .reminder-bell.active { color: #facc15; } /* yellow-400 */

        #match-details-modal.open {
            transform: scale(1);
            opacity: 1;
        }

        .comments-collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        .comments-collapsible-content.open {
            max-height: 500px; 
            opacity: 1;
        }

        #user-dropdown {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        /* Estilos para o seletor de visualiza√ß√£o */
        .view-switcher {
            display: inline-flex;
            background-color: #374151; /* gray-700 */
            border-radius: 0.5rem;
            padding: 0.25rem;
            position: relative;
            z-index: 10;
        }
        .view-switcher button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #d1d5db; /* gray-300 */
            transition: background-color 0.2s, color 0.2s;
            border: none;
            background-color: transparent;
        }
        .view-switcher button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        /* Estilos para a visualiza√ß√£o de semana */
        #week-view-container {
            display: none; /* Come√ßa oculto */
        }
        .week-day-column {
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 400px;
        }
        .week-match-card {
            background-color: #374151; /* gray-700 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .week-match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Estilos para emblemas e √≠cones */
        .team-badge {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
            object-fit: contain;
        }
        .special-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body class="text-gray-200">
    
    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar" class="w-72 bg-gray-900 p-6 flex flex-col space-y-6 overflow-y-auto">
            <h2 class="text-2xl font-bold text-white whitespace-nowrap">Navega√ß√£o</h2>
            <nav>
                <ul>
                    <li class="nav-item"><a href="Partidas.html" class="block py-2 px-4 rounded-lg bg-indigo-600 text-white">Calend√°rio de Partidas</a></li>
                    <li class="nav-item"><a href="eventos.html" class="block py-2 px-4 rounded-lg hover:bg-gray-700">Eventos</a></li>
                </ul>
            </nav>

            <hr class="border-gray-700">

            <div id="filter-container">
                <h2 class="text-2xl font-bold text-white whitespace-nowrap">Filtros</h2>

                <div class="filter-item mt-4">
                    <label for="view-mode" class="block text-sm font-medium text-gray-400 mb-2 whitespace-nowrap">Mostrar eventos:</label>
                    <select id="view-mode" class="w-full bg-gray-800 border-gray-700 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="principais">Principais Eventos (Filtrados)</option>
                        <option value="todos">Todos os Eventos</option>
                        <option value="lembretes">Meus Lembretes üîî</option>
                    </select>
                </div>
                
                <div class="filter-item mt-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2 whitespace-nowrap">Per√≠odo:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center"><input type="radio" name="event-period" value="upcoming" class="text-indigo-600 bg-gray-700 border-gray-600 focus:ring-indigo-500" checked><span class="ml-2">Pr√≥ximos</span></label>
                        <label class="flex items-center"><input type="radio" name="event-period" value="past" class="text-indigo-600 bg-gray-700 border-gray-600 focus:ring-indigo-500"><span class="ml-2">Anteriores</span></label>
                    </div>
                </div>

                <div id="team-search-container" class="filter-item mt-4">
                    <label for="team-search" class="block text-sm font-medium text-gray-400 mb-2 whitespace-nowrap">Buscar por time:</label>
                    <div class="relative">
                        <input type="text" id="team-search" placeholder="Ex: Palmeiras" class="w-full bg-gray-800 border-gray-700 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                        <div id="autocomplete-results" class="absolute z-20 w-full bg-gray-700 rounded-b-lg shadow-lg hidden max-h-60 overflow-y-auto"></div>
                    </div>
                </div>

                <div id="hot-games-filter-container" class="whitespace-nowrap filter-item mt-4">
                    <label for="hot-games-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="hot-games-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-300">Apenas Jogos Quentes üî•</span>
                    </label>
                </div>

                <div id="galo-only-filter-container" class="whitespace-nowrap filter-item mt-4">
                    <label for="galo-only-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="galo-only-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
                        <span class="ml-3 text-sm font-medium text-gray-300 flex items-center">
                            Apenas GALO
                            <img src="https://atletico.com.br/wp-content/uploads/2022/01/atletico.svg" class="w-5 h-5 ml-2">
                        </span>
                    </label>
                </div>

                <div id="sport-filters" class="whitespace-nowrap filter-item mt-4">
                    <h3 class="text-lg font-semibold text-white mb-2">Esportes</h3>
                </div>

                <div id="league-filters" class="whitespace-nowrap hidden filter-item mt-4">
                    <h3 class="text-lg font-semibold text-white mb-2">Campeonatos</h3>
                    <select id="league-select" multiple class="w-full bg-gray-800 border-gray-700 rounded-lg p-2 h-48 focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
            </div>
            
            <div id="save-status-container" class="mt-auto pt-4 border-t border-gray-700">
                 <p id="save-status" class="text-sm text-yellow-400 h-5 text-center whitespace-nowrap"></p>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto relative">
            <button id="sidebar-toggle" class="absolute top-6 left-6 z-30 p-2 rounded-full bg-gray-800 hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>

            <div id="auth-section" class="absolute top-6 right-6 z-30">
                <button id="login-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg hidden whitespace-nowrap">
                    Login com Google
                </button>
            
                <div id="user-profile-area" class="relative hidden">
                    <img id="user-photo" class="w-10 h-10 rounded-full cursor-pointer border-2 border-transparent hover:border-indigo-500 transition-colors" alt="Foto do usu√°rio">
                    <div id="user-dropdown" class="absolute right-0 mt-2 w-56 bg-gray-700 rounded-md shadow-lg py-1 hidden transform opacity-0 scale-95 transition ease-in-out duration-100">
                        <div class="px-4 py-3 text-sm text-gray-200">
                            <p class="font-semibold">Logado como:</p>
                            <p id="user-name" class="truncate"></p>
                        </div>
                        <div class="border-t border-gray-600"></div>
                        <a href="#" id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-600 hover:text-red-300">Sair</a>
                    </div>
                </div>
            </div>


            <div class="flex items-center justify-center mb-6">
                <h1 class="text-3xl font-bold text-white">Calend√°rio de Partidas</h1>
            </div>

            <div class="flex justify-center mb-6">
                <div class="view-switcher" id="view-switcher">
                    <button data-view="month" class="active">M√™s</button>
                    <button data-view="week">Semana</button>
                </div>
            </div>

            <div id="calendar-background-particles"></div>
            
            <div id="month-view-container">
                <div id="next-event-prompt" class="absolute inset-0 flex-col items-center justify-center bg-black bg-opacity-75 hidden z-20 rounded-lg p-8 text-center">
                    <p id="prompt-title" class="text-2xl font-bold text-white mb-4"></p>
                    <button id="jump-to-event-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center transition-transform transform hover:scale-105">
                        <span id="jump-text"></span><span id="jump-date" class="ml-2 font-black"></span><svg id="jump-arrow" class="w-6 h-6 ml-2" fill="currentColor" viewBox="0 0 24 24"></svg>
                    </button>
                </div>
                
                <div id="calendars-container" class="relative flex justify-center items-start">
                    <div id="calendar-1" class="w-full max-w-xl px-4">
                        <div class="flex items-center justify-center relative mb-4">
                            <button id="prev-month" class="absolute left-0 p-2 rounded-full hover:bg-gray-700 text-white"><</button>
                            <h2 id="month-year-1" class="text-2xl font-bold"></h2>
                        </div>
                        <div class="grid grid-cols-7 gap-4 text-center text-gray-400 font-semibold mb-2"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div></div>
                        <div id="calendar-grid-1" class="grid grid-cols-7 gap-4"></div>
                    </div>
                    <div class="h-auto self-stretch border-l border-gray-700 mx-4"></div>
                    <div id="calendar-2" class="w-full max-w-xl px-4">
                        <div class="flex items-center justify-center relative mb-4">
                            <h2 id="month-year-2" class="text-2xl font-bold"></h2>
                            <button id="next-month" class="absolute right-0 p-2 rounded-full hover:bg-gray-700 text-white">></button>
                        </div>
                        <div class="grid grid-cols-7 gap-4 text-center text-gray-400 font-semibold mb-2"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div></div>
                        <div id="calendar-grid-2" class="grid grid-cols-7 gap-4"></div>
                    </div>
                </div>
            </div>

            <div id="week-view-container" class="relative">
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-week" class="p-2 rounded-full hover:bg-gray-700 text-white z-10">< Semana Anterior</button>
                    <h2 id="week-header" class="text-2xl font-bold text-center"></h2>
                    <button id="next-week" class="p-2 rounded-full hover:bg-gray-700 text-white z-10">Pr√≥xima Semana ></button>
                </div>
                <div id="week-grid" class="grid grid-cols-1 md:grid-cols-7 gap-2">
                    </div>
            </div>

            <div id="loading-indicator" class="text-center py-10 hidden">Carregando eventos...</div>
        </main>
    </div>

    <div id="day-details-panel" class="fixed top-0 right-0 h-full w-full max-w-md bg-gray-800 shadow-lg p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6"><h2 id="details-title" class="text-2xl font-bold text-white">Eventos do Dia</h2><button id="close-details" class="p-2 rounded-full hover:bg-gray-700">X</button></div>
        <div id="details-content" class="space-y-4"></div>
        
    </div>

    <div id="match-details-modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div id="match-details-modal" class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col scale-95 opacity-0 transition-all duration-300">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                <div id="modal-match-title" class="text-xl font-bold text-white flex items-center gap-x-3"></div>
                <button id="close-match-modal-btn" class="p-2 rounded-full hover:bg-gray-700 text-2xl leading-none">√ó</button>
            </div>
            <div id="modal-match-content" class="p-6 overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 w-full max-w-sm space-y-4 z-50">
        
        <div id="galo-toast" class="bg-gray-800 rounded-lg shadow-lg text-white hidden transform transition-all duration-300 translate-y-16 p-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h3 class="font-bold flex items-center">
                        Pr√≥ximas Partidas do 
                        <img src="https://atletico.com.br/wp-content/uploads/2022/01/atletico.svg" class="w-5 h-5 mx-1">
                        !
                    </h3>
                    <p id="galo-message" class="text-sm mt-1 whitespace-pre-wrap"></p>
                </div>
                <button id="close-galo-toast" class="ml-2 text-gray-400 hover:text-white text-2xl leading-none">√ó</button>
            </div>
        </div>
        <div id="welcome-toast" class="bg-gray-800 rounded-lg shadow-lg text-white hidden transform transition-all duration-300 translate-y-16 p-4">
            <div class="flex justify-between items-start"><div class="flex-1"><h3 class="font-bold">üî• Fique de Olho!</h3><p id="toast-message" class="text-sm mt-1 whitespace-pre-wrap"></p></div><button id="close-toast" class="ml-2 text-gray-400 hover:text-white text-2xl leading-none">√ó</button></div>
        </div>
         <div id="reminder-toast" class="bg-indigo-700 rounded-lg shadow-lg text-white hidden transform transition-all duration-300 translate-y-16 p-4">
            <div class="flex justify-between items-start"><div class="flex-1"><h3 class="font-bold">üîî Lembretes para Hoje!</h3><p id="reminder-message" class="text-sm mt-1 whitespace-pre-wrap"></p></div><button id="close-reminder-toast" class="ml-2 text-gray-400 hover:text-white text-2xl leading-none">√ó</button></div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js"; 
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc, addDoc, deleteDoc, query, where, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAsFvuMeDRo0jNRgIwq0NGoG2-XkP7Eed4",
            authDomain: "calendario3-3.firebaseapp.com",
            projectId: "calendario3-3",
            storageBucket: "calendario3-3.firebasestorage.app",
            messagingSenderId: "672943308005",
            appId: "1:672943308005:web:99f1879c9ea90d382c680c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 
        const db = getFirestore(app); 

        document.addEventListener('DOMContentLoaded', async () => {
            // --- ELEMENTOS DO DOM ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle');
            const teamSearchInput = document.getElementById('team-search');
            const autocompleteResults = document.getElementById('autocomplete-results');
            const sportFiltersContainer = document.getElementById('sport-filters');
            const leagueFiltersContainer = document.getElementById('league-filters');
            const leagueSelect = document.getElementById('league-select');
            const hotGamesToggle = document.getElementById('hot-games-toggle');
            const galoOnlyToggle = document.getElementById('galo-only-toggle');
            const loadingIndicator = document.getElementById('loading-indicator');
            const detailsPanel = document.getElementById('day-details-panel');
            const detailsTitle = document.getElementById('details-title');
            const detailsContent = document.getElementById('details-content');
            const closeDetailsBtn = document.getElementById('close-details');
            const nextEventPrompt = document.getElementById('next-event-prompt');
            const saveStatus = document.getElementById('save-status');
            const viewModeSelect = document.getElementById('view-mode');
            const loginButton = document.getElementById('login-button');
            const logoutButton = document.getElementById('logout-button');
            const userProfileArea = document.getElementById('user-profile-area');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const userDropdown = document.getElementById('user-dropdown');
            const matchDetailsModalOverlay = document.getElementById('match-details-modal-overlay');
            const matchDetailsModal = document.getElementById('match-details-modal');
            const modalMatchTitle = document.getElementById('modal-match-title');
            const modalMatchContent = document.getElementById('modal-match-content');
            const closeMatchModalBtn = document.getElementById('close-match-modal-btn');
            
            // --- ELEMENTOS DE VISUALIZA√á√ÉO ---
            const viewSwitcher = document.getElementById('view-switcher');
            const monthViewContainer = document.getElementById('month-view-container');
            const weekViewContainer = document.getElementById('week-view-container');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month'); 
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            const weekHeader = document.getElementById('week-header');
            const weekGrid = document.getElementById('week-grid');

            // --- CONFIGURA√á√ÉO ---
            const API_KEY = '373862';
            const CACHE_DURATION_MINUTES = 15;
            const CACHE_VERSION = '1.8'; // Vers√£o incrementada para limpar cache antigo
            const GALO_ICON_URL = 'https://atletico.com.br/wp-content/uploads/2022/01/atletico.svg';
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5aInrAmXeUCwn40ybZVbx8efrQQyAw6BvUnHYG9X_MLkmjHCFBtjwMVROZZDzgTTl/exec';
            const galoAliases = ['atl√©tico-mg', 'galo', 'atletico mg', 'atletico mineiro'];

            const sportConfigs = {
                'Futebol': { color: 'bg-blue-500', particleColor: '#3b82f6', backgroundImage: 'url(https://images.unsplash.com/photo-1508098682722-e99c43a406b2?q=80&w=1000&auto=format&fit=crop)', leagues: { 'serie_a': { id: '4351', name: 'Brasileir√£o S√©rie A' }, 'copa_do_brasil': { id: '4725', name: 'Copa do Brasil' }, 'libertadores': { id: '4501', name: 'Copa Libertadores' }, 'sudamericana': { id: '4724', name: 'Copa Sudamericana' }, 'premier_league': { id: '4328', name: 'English Premier League' }, 'la_liga': { id: '4335', name: 'Spanish La Liga' }, 'serie_a_italy': { id: '4332', name: 'Italian Serie A' }, 'primeira_liga': { id: '4344', name: 'Portuguese Primeira Liga' }, 'champions_league': { id: '4480', name: 'UEFA Champions League' }, 'copa_america': { id: '4499', name: 'Copa America' }, 'world_cup': { id: '4429', name: 'FIFA World Cup' }, 'mundial_clubes': { id: '4503', name: 'FIFA Club World Cup' }, 'bundesliga': { id: '4331', name: 'German Bundesliga' }, 'mls': { id: '4346', name: 'American Major League Soccer' }, 'arg_primera': { id: '4406', name: 'Argentinian Primera Division' } } },
                'Basquete': { color: 'bg-orange-500', particleColor: '#f97316', backgroundImage: 'url(https://images.unsplash.com/photo-1574313433589-b3575d5a711?q=80&w=1000&auto=format&fit=crop)', leagues: { 'nba': { id: '4387', name: 'NBA' } } },
                'T√™nis': { color: 'bg-lime-500', particleColor: '#84cc16', backgroundImage: 'url(https://images.unsplash.com/photo-1554062234-3180f9344402?q=80&w=1000&auto=format&fit=crop)', leagues: { 'atp_world_tour': { id: '4464', name: 'ATP World Tour' }, 'wta_tour': { id: '4517', name: 'WTA Tour' } } },
                'ESports': { color: 'bg-purple-500', particleColor: '#a855f7', backgroundImage: 'url(https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=1000&auto=format&fit=crop)', leagues: { 'lol_worlds': { id: '4514', name: 'LoL World Championship' }, 'lol_lpl': { id: '4528', name: 'LoL Pro League (LPL)' }, 'lol_lck': { id: '4529', name: 'LoL Champions Korea (LCK)' }, 'lol_lec': { id: '4530', name: 'LoL EMEA Championship (LEC)' }, 'lol_lcs': { id: '4531', name: 'LoL Championship Series (LCS)' }, 'lol_lta': { id: '5631', name: 'League of The Americas (LTA)' }, 'cs_esl': { id: '5425', name: 'ESL Pro League (CS)' }, 'cs_blast': { id: '5426', name: 'Blast Premier (CS)' } } },
                'Poker': { color: 'bg-red-600', particleColor: '#dc2626', backgroundImage: 'url(https://images.unsplash.com/photo-1542822014-9e35b06f4527?q=80&w=1000&auto=format&fit=crop)', leagues: { 'wsop': { id: '5452', name: 'World Series of Poker' }, 'wsop_europe': { id: '5453', name: 'WSOP Europe' }, 'poker_masters': { id: '5459', name: 'Poker Masters' }, 'us_poker_open': { id: '5460', name: 'US Poker Open' } } }
            };
            
            const topTeams = [ 'Palmeiras', 'Flamengo', 'Corinthians', 'Sao Paulo', 'Santos', 'Gremio', 'Internacional', 'Cruzeiro', 'Vasco da Gama', 'Fluminense', 'Botafogo', 'Athletico Paranaense', 'Boca Juniors', 'River Plate', 'Racing Club', 'Independiente', 'Penarol', 'Nacional', 'Atletico Nacional', 'LDU Quito', 'Manchester City', 'Liverpool', 'Chelsea', 'Manchester United', 'Arsenal', 'Tottenham', 'Real Madrid', 'Barcelona', 'Atletico Madrid', 'Sevilla', 'Juventus', 'Inter', 'AC Milan', 'Napoli', 'Roma', 'Lazio', 'Fiorentina', 'Bayern Munich', 'Borussia Dortmund', 'Paris Saint-Germain', 'Marseille', 'Lyon', 'Paris SG', 'Benfica', 'Porto', 'Sporting CP', 'Ajax', 'Al Hilal', 'Al Ahly', 'Brazil', 'Argentina', 'France', 'Germany', 'Spain', 'England', 'Portugal', 'Italy', 'Netherlands', 'Uruguay', 'Belgium', 'Croatia' ];

            // --- ESTADO DA APLICA√á√ÉO ---
            let currentView = 'month'; // 'month' ou 'week'
            let currentDate = new Date();
            let currentWeekDate = new Date();
            let allEventsData = { upcoming: null, past: null };
            let eventPeriod = 'upcoming';
            let savedReminders = [];
            let currentUser = null;

            // --- FUN√á√ïES HELPER ---
            const normalizeString = (str) => {
                if (!str) return '';
                return str
                    .toLowerCase()
                    .normalize("NFD") 
                    .replace(/[\u0300-\u036f]/g, "") 
                    .replace(/[^a-z0-9]/g, ''); 
            };
            
            const isGaloGame = (event) => {
                if (!event) return false;
                const homeTeamNormalized = normalizeString(event.strHomeTeam);
                const awayTeamNormalized = normalizeString(event.strAwayTeam);

                return galoAliases.some(alias => {
                    const normalizedAlias = normalizeString(alias);
                    return homeTeamNormalized.includes(normalizedAlias) || awayTeamNormalized.includes(normalizedAlias);
                });
            };

            const getEventScore = (event) => {
                if (isGaloGame(event)) return 2;
                if (topTeams.includes(event.strHomeTeam) && topTeams.includes(event.strAwayTeam)) return 1;
                return 0;
            };

            function animateCalendarDays() {
                const days = document.querySelectorAll('.calendar-day');
                days.forEach((day, index) => {
                    setTimeout(() => {
                        day.classList.add('visible');
                    }, index * 20); 
                });
            }

            const getCache = key => {
                const itemStr = localStorage.getItem(key);
                if (!itemStr) return null;
                const item = JSON.parse(itemStr);
                if (item.version !== CACHE_VERSION || new Date().getTime() > item.expiry) {
                    localStorage.removeItem(key); return null;
                }
                return item.value;
            };

            const setCache = (key, value) => {
                const item = { value, version: CACHE_VERSION, expiry: new Date().getTime() + CACHE_DURATION_MINUTES * 60 * 1000 };
                localStorage.setItem(key, JSON.stringify(item));
            };
            
            async function saveToSheets(events) {
                if (!GOOGLE_SCRIPT_URL || !events || events.length === 0) return;
                saveStatus.textContent = 'Sincronizando com hist√≥rico...';
                saveStatus.className = 'text-yellow-400 text-sm h-5 text-center whitespace-nowrap';
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ events }),
                    });
                    saveStatus.textContent = 'Hist√≥rico sincronizado!';
                    saveStatus.className = 'text-green-400 text-sm h-5 text-center whitespace-nowrap';
                } catch (error) {
                    console.error('Failed to save to sheets:', error);
                    saveStatus.textContent = 'Erro ao sincronizar.';
                    saveStatus.className = 'text-red-400 text-sm h-5 text-center whitespace-nowrap';
                }
            }
            
            function showToast(toastId, message) {
                const toast = document.getElementById(toastId);
                const messageEl = toast.querySelector('p');
                const closeBtn = toast.querySelector('button');

                messageEl.textContent = message;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.remove('translate-y-16'), 100);

                const closeHandler = () => {
                    toast.classList.add('translate-y-16');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                    document.body.removeEventListener('click', closeHandler, true);
                };

                closeBtn.onclick = (e) => { e.stopPropagation(); closeHandler(); };
                setTimeout(() => document.body.addEventListener('click', closeHandler, true), 50);
                toast.addEventListener('click', e => e.stopPropagation());
            }

            function checkAndNotify() {
                const todayStr = new Date().toISOString().split('T')[0];
                const todaysReminders = savedReminders
                    .map(id => (allEventsData.upcoming || []).find(e => e.idEvent === id))
                    .filter(event => event && event.dateEvent === todayStr);

                if (todaysReminders.length > 0) {
                     let message = "Lembretes para hoje:\n";
                    todaysReminders.forEach(event => { message += `- ${event.strEvent}\n`; });
                    showToast('reminder-toast', message.trim());
                }
                
                // L√≥gica para o novo Pop-up do Atl√©tico-MG
                const upcomingGaloGames = (allEventsData.upcoming || []).filter(isGaloGame);
                
                if (upcomingGaloGames.length > 0) {
                    let galoMessage = "Fique ligado nos pr√≥ximos jogos do GALO:\n";
                    upcomingGaloGames.forEach(event => {
                        const eventDate = new Date(event.dateEvent + 'T00:00:00');
                        const dateString = eventDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                        galoMessage += `- ${event.strEvent} (${dateString})\n`;
                    });
                    setTimeout(() => showToast('galo-toast', galoMessage.trim()), 500); // Aparece primeiro
                }

                // L√≥gica para o Pop-up de Jogos Quentes (existente)
                const today = new Date(); 
                today.setHours(0, 0, 0, 0);
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);

                const upcomingHotGames = (allEventsData.upcoming || [])
                    .filter(e => {
                        const eventDate = new Date(e.dateEvent + 'T00:00:00');
                        // Exclui jogos do galo para n√£o duplicar a informa√ß√£o principal
                        return !isGaloGame(e) && getEventScore(e) > 0 && eventDate >= today && eventDate <= nextWeek;
                    })
                    .sort((a,b) => new Date(a.dateEvent) - new Date(b.dateEvent));
                
                if (upcomingHotGames.length > 0) {
                    const welcomeToastTitle = document.querySelector('#welcome-toast h3');
                    if (welcomeToastTitle) {
                        welcomeToastTitle.innerHTML = `üî• Fique de Olho!`;
                    }
                    
                    let message = "Confira outros jogos importantes da semana:\n";
                    upcomingHotGames.slice(0, 5).forEach(event => {
                        const eventDate = new Date(event.dateEvent + 'T00:00:00');
                        const dateString = eventDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                        message += `- ${event.strEvent} (${dateString})\n`;
                    });
                    if (upcomingHotGames.length > 5) {
                        message += `\n... e mais ${upcomingHotGames.length - 5} jogos.`;
                    }

                    setTimeout(() => showToast('welcome-toast', message.trim()), 1500); // Aparece depois
                }
            }

            async function fetchAllEventsForPeriod() {
                loadingIndicator.style.display = 'block';
                const cacheKey = `all_events_cache_${eventPeriod}_v${CACHE_VERSION}`;
                let cachedEvents = getCache(cacheKey);

                if (cachedEvents) {
                    allEventsData[eventPeriod] = cachedEvents;
                } else {
                    const endpointType = eventPeriod === 'upcoming' ? 'eventsnextleague' : 'eventspastleague';
                    const promises = [];
                    for (const sportName in sportConfigs) {
                        for (const leagueKey in sportConfigs[sportName].leagues) {
                            const leagueId = sportConfigs[sportName].leagues[leagueKey].id;
                            const url = `https://www.thesportsdb.com/api/v1/json/${API_KEY}/${endpointType}.php?id=${leagueId}`;
                            promises.push(fetch(url).then(res => res.json()).catch(err => ({ events: [] })));
                        }
                    }

                    // Adiciona a nova API espec√≠fica do Atl√©tico-MG apenas para eventos futuros
                    if (eventPeriod === 'upcoming') {
                        const galoApiUrl = `https://www.thesportsdb.com/api/v1/json/${API_KEY}/eventsnext.php?id=134299`;
                        promises.push(fetch(galoApiUrl).then(res => res.json()).catch(err => ({ events: [] })));
                    }

                    const results = await Promise.all(promises);
                    const fetchedEvents = results.flatMap(result => result.events || []);

                    // L√≥gica para remover duplicatas
                    const uniqueEventsMap = new Map();
                    fetchedEvents.forEach(event => {
                        if (event && event.idEvent && !uniqueEventsMap.has(event.idEvent)) {
                            uniqueEventsMap.set(event.idEvent, event);
                        }
                    });
                    const uniqueFetchedEvents = Array.from(uniqueEventsMap.values());

                    allEventsData[eventPeriod] = uniqueFetchedEvents;
                    setCache(cacheKey, uniqueFetchedEvents);
                }
                
                loadingIndicator.style.display = 'none';
                applyFiltersAndRender();
                if(eventPeriod === 'upcoming') checkAndNotify();
            }
            
            async function loadParticles(colors = ["#ffffff"]) {
                await tsParticles.load("calendar-background-particles", {
                    fpsLimit: 60,
                    particles: { number: { value: 30, density: { enable: true, value_area: 400 } }, color: { value: colors }, shape: { type: "circle" }, opacity: { value: 0.3, random: true }, size: { value: 2, random: { enable: true, minimumValue: 1 } }, move: { enable: true, speed: 0.5, direction: "none", random: true, straight: false, out_mode: "bounce", bounce: true }, links: { enable: true, distance: 100, color: "#ffffff", opacity: 0.1, width: 1 } },
                    interactivity: { events: { onHover: { enable: true, mode: "grab" }, onClick: { enable: true, mode: "push" } }, modes: { grab: { distance: 100, links: { opacity: 0.2 } }, push: { quantity: 1 } } },
                    detectRetina: true
                });
            }

            function renderCalendar(events) {
                if (currentView === 'month') {
                    monthViewContainer.style.display = 'block';
                    weekViewContainer.style.display = 'none';
                    renderTwoMonths(new Date(currentDate), events);
                } else {
                    monthViewContainer.style.display = 'none';
                    weekViewContainer.style.display = 'block';
                    renderWeekView(new Date(currentWeekDate), events);
                }
            }

            function renderSingleCalendar(gridId, monthYearId, month, year, events) {
                const grid = document.getElementById(gridId);
                const monthYearEl = document.getElementById(monthYearId);
                
                grid.innerHTML = '';
                monthYearEl.textContent = `${new Date(year, month).toLocaleString('pt-BR', { month: 'long' })} de ${year}`;
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDay; i++) { grid.insertAdjacentHTML('beforeend', '<div></div>'); }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day border border-gray-700 rounded-lg p-2 h-20 flex flex-col';
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const eventsOnDay = events.filter(e => e.dateEvent === dateStr);
                    
                    const hasGaloGame = eventsOnDay.some(isGaloGame);
                    const isHotDay = eventsOnDay.some(e => topTeams.includes(e.strHomeTeam) && topTeams.includes(e.strAwayTeam));
                    
                    let iconsHTML = '';
                    if(hasGaloGame) iconsHTML += `<img src="${GALO_ICON_URL}" class="special-icon">`;
                    if(isHotDay) iconsHTML += `<span class="text-base">üî•</span>`;

                    dayEl.innerHTML = `<div class="flex justify-between items-center"><span class="font-bold">${day}</span><div class="flex items-center gap-x-1">${iconsHTML}</div></div>`;

                    if (eventsOnDay.length > 0) {
                        dayEl.classList.add('has-events');
                        dayEl.dataset.date = dateStr;
                        
                        const indicators = document.createElement('div');
                        indicators.className = 'flex items-center space-x-1 mt-auto';
                        
                        const sportsOnDay = [...new Set(eventsOnDay.map(e => getSportByLeagueId(e.idLeague)))];
                        sportsOnDay.forEach(sportName => {
                            if (sportName) indicators.innerHTML += `<div class="w-2 h-2 rounded-full ${sportConfigs[sportName]?.color || 'bg-gray-500'}"></div>`;
                        });

                        dayEl.appendChild(indicators);
                        dayEl.addEventListener('click', () => showDayDetails(dateStr));
                    }
                    
                    const today = new Date();
                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayEl.classList.add('today');
                    }
                    grid.appendChild(dayEl);
                }
            }
            
            function renderTwoMonths(date, events) {
                const month1 = date.getMonth();
                const year1 = date.getFullYear();
                renderSingleCalendar('calendar-grid-1', 'month-year-1', month1, year1, events);
                const date2 = new Date(date);
                date2.setMonth(date2.getMonth() + 1);
                const month2 = date2.getMonth();
                const year2 = date2.getFullYear();
                renderSingleCalendar('calendar-grid-2', 'month-year-2', month2, year2, events);
                animateCalendarDays();
            }

            const formatDisplayDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return `${day}/${month}`;
            };

            function renderWeekView(date, events) {
                weekGrid.innerHTML = '';
                const startOfWeek = new Date(date);
                startOfWeek.setDate(startOfWeek.getDate() - date.getDay()); 
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);

                weekHeader.textContent = `${formatDisplayDate(startOfWeek)} - ${formatDisplayDate(endOfWeek)}`;
                const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

                for(let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(startOfWeek.getDate() + i);
                    const dateStr = `${dayDate.getFullYear()}-${String(dayDate.getMonth() + 1).padStart(2, '0')}-${String(dayDate.getDate()).padStart(2, '0')}`;
                    
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'week-day-column';

                    const today = new Date();
                    const isToday = dayDate.getFullYear() === today.getFullYear() && dayDate.getMonth() === today.getMonth() && dayDate.getDate() === today.getDate();

                    dayColumn.innerHTML = `<h3 class="font-bold text-lg text-center mb-4 ${isToday ? 'text-indigo-400' : ''}">${weekDays[i]} <span class="text-gray-400 text-base">${dayDate.getDate()}</span></h3>`;
                    
                    let eventsOnDay = events.filter(e => e.dateEvent === dateStr);
                    eventsOnDay.sort((a,b) => getEventScore(b) - getEventScore(a));
                    
                    const eventsContainer = document.createElement('div');
                    if (eventsOnDay.length > 0) {
                        eventsOnDay.forEach(event => {
                            const isHotGame = topTeams.includes(event.strHomeTeam) && topTeams.includes(event.strAwayTeam);
                            const eventIsGaloGame = isGaloGame(event);
                            const timeDisplay = (event.strTime && event.strTime !== "00:00:00") ? event.strTime.substring(0, 5) : 'A definir';
                            
                            const homeBadgeHTML = event.strHomeTeamBadge ? `<img src="${event.strHomeTeamBadge}" alt="${event.strHomeTeam}" class="team-badge w-5 h-5">` : '';
                            const awayBadgeHTML = event.strAwayTeamBadge ? `<img src="${event.strAwayTeamBadge}" alt="${event.strAwayTeam}" class="team-badge w-5 h-5">` : '';
                            
                            let iconsHTML = '';
                            if(eventIsGaloGame) iconsHTML += `<img src="${GALO_ICON_URL}" class="special-icon">`;
                            if(isHotGame) iconsHTML += `<span class="text-base">üî•</span>`;
                            
                            const eventCard = document.createElement('div');
                            eventCard.className = 'week-match-card';
                            eventCard.dataset.eventId = event.idEvent;
                            
                            eventCard.innerHTML = `
                                <div class="flex justify-between items-center text-xs text-gray-400 mb-2">
                                    <span class="truncate">${event.strLeague}</span>
                                    <span>${timeDisplay}</span>
                                </div>
                                <div class="font-bold text-white text-sm flex flex-col gap-y-1">
                                    <div class="flex items-center">${homeBadgeHTML}<span class="ml-2">${event.strHomeTeam}</span></div>
                                    <div class="flex items-center">${awayBadgeHTML}<span class="ml-2">${event.strAwayTeam}</span></div>
                                </div>
                                ${iconsHTML ? `<div class="flex justify-end items-center gap-x-1 mt-1">${iconsHTML}</div>` : ''}
                            `;
                            eventCard.addEventListener('click', () => openMatchDetailsModal(event));
                            eventsContainer.appendChild(eventCard);
                        });
                    } else {
                        eventsContainer.innerHTML = `<p class="text-center text-gray-500 text-sm mt-8">Nenhuma partida</p>`;
                    }
                    dayColumn.appendChild(eventsContainer);
                    weekGrid.appendChild(dayColumn);
                }
            }

            function populateFilters() {
                let sportHtml = '';
                leagueSelect.innerHTML = '';
                
                for (const sportName in sportConfigs) {
                    sportHtml += `<label class="flex items-center space-x-2 filter-item"><input type="checkbox" value="${sportName}" class="sport-filter bg-gray-700 border-gray-600 rounded"><span>${sportName}</span></label>`;
                    
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = sportName;
                    optgroup.dataset.sport = sportName;
                    
                    if (sportConfigs[sportName].leagues) {
                        for (const leagueKey in sportConfigs[sportName].leagues) {
                            const league = sportConfigs[sportName].leagues[leagueKey];
                            const option = document.createElement('option');
                            option.value = league.id;
                            option.textContent = league.name;
                            optgroup.appendChild(option);
                        }
                    }
                    leagueSelect.appendChild(optgroup);
                }
                document.querySelector('#sport-filters').innerHTML += sportHtml;

                document.querySelectorAll('.sport-filter').forEach(el => el.addEventListener('change', updateLeagueFilterVisibility));
                leagueSelect.addEventListener('change', applyFiltersAndRender);
            }

            function updateLeagueFilterVisibility() {
                const selectedSports = [...document.querySelectorAll('.sport-filter:checked')].map(el => el.value);
                
                leagueFiltersContainer.classList.toggle('hidden', selectedSports.length === 0);

                document.querySelectorAll('#league-select optgroup').forEach(optgroup => {
                    const shouldShow = selectedSports.includes(optgroup.dataset.sport);
                    optgroup.style.display = shouldShow ? 'block' : 'none';
                    if (!shouldShow) {
                        optgroup.querySelectorAll('option').forEach(option => option.selected = false);
                    }
                });

                const particleColors = selectedSports.length > 0 ? selectedSports.map(sport => sportConfigs[sport]?.particleColor || '#ffffff') : ['#ffffff'];
                loadParticles(particleColors);
                
                applyFiltersAndRender();
            }
            
            function applyFiltersAndRender() {
                nextEventPrompt.classList.add('hidden');
                let eventsToRender = allEventsData[eventPeriod] || [];
                const mode = viewModeSelect.value;
                const showOnlyGalo = galoOnlyToggle.checked;
                
                if (showOnlyGalo) {
                    eventsToRender = eventsToRender.filter(isGaloGame);
                } else if (mode === 'lembretes') {
                    eventsToRender = (allEventsData[eventPeriod] || []).filter(e => savedReminders.includes(e.idEvent));
                } else if (mode === 'principais') {
                    const searchTerm = teamSearchInput.value.toLowerCase();
                    const selectedSports = [...document.querySelectorAll('.sport-filter:checked')].map(el => el.value);
                    const selectedLeagues = [...leagueSelect.selectedOptions].map(opt => opt.value);
                    const showOnlyHotGames = hotGamesToggle.checked;
                    
                    if (selectedSports.length > 0) eventsToRender = eventsToRender.filter(e => selectedSports.includes(getSportByLeagueId(e.idLeague)));
                    if (selectedLeagues.length > 0) eventsToRender = eventsToRender.filter(e => selectedLeagues.includes(e.idLeague));
                    if (searchTerm) eventsToRender = eventsToRender.filter(e => (e.strHomeTeam?.toLowerCase().includes(searchTerm) || e.strAwayTeam?.toLowerCase().includes(searchTerm)));
                    if (showOnlyHotGames) eventsToRender = eventsToRender.filter(e => topTeams.includes(e.strHomeTeam) && topTeams.includes(e.strAwayTeam));
                }
                
                renderCalendar(eventsToRender);
                
                if (currentView === 'month') {
                    const firstDayOfView = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const lastDayOfView = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0);

                    const hasEventsInView = eventsToRender.some(e => new Date(e.dateEvent + 'T00:00:00') >= firstDayOfView && new Date(e.dateEvent + 'T00:00:00') <= lastDayOfView);
                    
                    if (!hasEventsInView && eventsToRender.length > 0) {
                        const sortedEvents = eventsToRender.map(e => ({ ...e, dateObj: new Date(e.dateEvent + 'T00:00:00')}))
                            .sort((a,b) => eventPeriod === 'upcoming' ? a.dateObj - b.dateObj : b.dateObj - a.dateObj);
                        
                        const nextEvent = eventPeriod === 'upcoming' 
                            ? sortedEvents.find(e => e.dateObj > lastDayOfView)
                            : sortedEvents.find(e => e.dateObj < firstDayOfView);

                        if(nextEvent) {
                            document.getElementById('prompt-title').textContent = `Nenhum ${eventPeriod === 'upcoming' ? 'pr√≥ximo evento' : 'resultado'} na visualiza√ß√£o atual`;
                            document.getElementById('jump-text').textContent = `Ir para o ${eventPeriod === 'upcoming' ? 'pr√≥ximo evento' : '√∫ltimo resultado'} em`;
                            document.getElementById('jump-arrow').innerHTML = eventPeriod === 'upcoming' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>';
                            
                            const nextEventDate = nextEvent.dateObj;
                            document.getElementById('jump-date').textContent = nextEventDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                            nextEventPrompt.classList.remove('hidden');
                            
                            document.getElementById('jump-to-event-btn').onclick = () => {
                                currentDate = new Date(nextEventDate.getFullYear(), nextEventDate.getMonth(), 1);
                                applyFiltersAndRender();
                            };
                        }
                    }
                }
            }
            
            // Firebase Related Functions
            async function saveUserReminder(userId, eventId) {
                try {
                    const userRef = doc(db, 'users', userId);
                    await setDoc(userRef, { reminders: arrayUnion(eventId) }, { merge: true }); 
                } catch (error) {
                    console.error('Error saving reminder to Firestore:', error);
                }
            }

            async function removeUserReminder(userId, eventId) {
                try {
                    const userRef = doc(db, 'users', userId);
                    await updateDoc(userRef, { reminders: arrayRemove(eventId) });
                } catch (error) {
                    console.error('Error removing reminder from Firestore:', error);
                }
            }

            async function loadUserReminders(userId) {
                try {
                    const userDocRef = doc(db, 'users', userId);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        savedReminders = userDoc.data().reminders || [];
                    } else {
                        savedReminders = [];
                    }
                    applyFiltersAndRender();
                } catch (error) {
                    console.error('Error loading reminders from Firestore:', error);
                    savedReminders = [];
                }
            }

            async function saveUserComment(userId, userName, userPhotoUrl, eventId, commentText) {
                try {
                    const newCommentRef = await addDoc(collection(db, 'comments'), {
                        userId: userId, userName: userName, userPhoto: userPhotoUrl, eventId: eventId, comment: commentText, timestamp: serverTimestamp()
                    });
                    const newCommentSnap = await getDoc(newCommentRef);
                    if (newCommentSnap.exists()) {
                        const commentData = newCommentSnap.data();
                        const commentsListElement = document.getElementById(`comments-list-${eventId}`);
                        const noCommentsMessageElement = document.getElementById(`no-comments-message-${eventId}`);
                        const commentHtml = `
                            <div class="bg-gray-700 p-3 rounded-lg flex items-start space-x-3 relative">
                                <img src="${commentData.userPhoto || 'https://via.placeholder.com/24/374151/FFFFFF?text=?'}" class="w-6 h-6 rounded-full" alt="User Photo">
                                <div>
                                    <p class="text-sm font-semibold text-white">${commentData.userName}</p>
                                    <p class="text-xs text-gray-400">${commentData.comment}</p>
                                    <p class="text-xs text-gray-500 mt-1">${new Date(commentData.timestamp.toDate()).toLocaleString('pt-BR')}</p>
                                </div>
                                <button class="absolute top-2 right-2 text-red-400 hover:text-red-600 text-sm font-bold" data-comment-id="${newCommentSnap.id}" data-event-id="${eventId}">Excluir</button>
                            </div>`;
                        if (noCommentsMessageElement && !noCommentsMessageElement.classList.contains('hidden')) {
                            noCommentsMessageElement.classList.add('hidden');
                        }
                        if (commentsListElement) {
                            commentsListElement.insertAdjacentHTML('beforeend', commentHtml);
                            const newDeleteButton = commentsListElement.querySelector(`[data-comment-id="${newCommentSnap.id}"]`);
                            if (newDeleteButton) {
                                 newDeleteButton.addEventListener('click', (e) => {
                                    const commentId = e.target.dataset.commentId;
                                    const eventId = e.target.dataset.eventId;
                                    if (confirm('Tem certeza que deseja excluir este coment√°rio?')) {
                                        deleteUserComment(commentId, eventId);
                                    }
                                });
                            }
                        }
                        const textareaForEvent = document.getElementById(`comment-text-${eventId}`);
                        if (textareaForEvent) textareaForEvent.value = '';
                    }
                } catch (error) {
                    console.error('Error saving comment:', error);
                    alert('Erro ao salvar coment√°rio. Tente novamente.');
                }
            }
            
            async function deleteUserComment(commentId, eventId) {
                try {
                    const commentRef = doc(db, 'comments', commentId);
                    await deleteDoc(commentRef);
                    const commentElement = document.querySelector(`button[data-comment-id="${commentId}"]`).closest('.bg-gray-700.p-3');
                    if (commentElement) {
                        commentElement.remove();
                    }
                    const commentsListElement = document.getElementById(`comments-list-${eventId}`);
                    if (commentsListElement && commentsListElement.children.length === 0) {
                        const noCommentsMessageElement = document.getElementById(`no-comments-message-${eventId}`);
                        if (noCommentsMessageElement) {
                            noCommentsMessageElement.classList.remove('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Error deleting comment:', error);
                    alert('Erro ao excluir coment√°rio. Tente novamente ou verifique se voc√™ √© o autor.');
                }
            }

            async function loadCommentsForEvent(eventId, commentsListElement, noCommentsMessageElement) {
                commentsListElement.innerHTML = ''; 
                noCommentsMessageElement.classList.add('hidden');
                try {
                    const commentsCollectionRef = collection(db, 'comments');
                    const q = query(commentsCollectionRef, where('eventId', '==', eventId), orderBy('timestamp', 'asc'));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        noCommentsMessageElement.classList.remove('hidden');
                        return;
                    }
                    snapshot.docs.forEach(docItem => {
                        const commentData = docItem.data();
                        const commentHtml = `
                            <div class="bg-gray-700 p-3 rounded-lg flex items-start space-x-3 relative">
                                <img src="${commentData.userPhoto || 'https://via.placeholder.com/24/374151/FFFFFF?text=?'}" class="w-6 h-6 rounded-full" alt="User Photo">
                                <div>
                                    <p class="text-sm font-semibold text-white">${commentData.userName}</p>
                                    <p class="text-xs text-gray-400">${commentData.comment}</p>
                                    <p class="text-xs text-gray-500 mt-1">${commentData.timestamp ? new Date(commentData.timestamp.toDate()).toLocaleString() : 'Data desconhecida'}</p>
                                </div>
                                ${currentUser && currentUser.uid === commentData.userId ? 
                                    `<button class="absolute top-2 right-2 text-red-400 hover:text-red-600 text-sm font-bold" data-comment-id="${docItem.id}" data-event-id="${eventId}">Excluir</button>` : ''
                                }
                            </div>`;
                        commentsListElement.insertAdjacentHTML('beforeend', commentHtml);
                    });
                    commentsListElement.querySelectorAll('button[data-comment-id]').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const commentId = e.target.dataset.commentId;
                            const eventId = e.target.dataset.eventId;
                            if (confirm('Tem certeza que deseja excluir este coment√°rio?')) {
                                deleteUserComment(commentId, eventId);
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error loading comments:', error);
                    commentsListElement.innerHTML = `<p class="text-red-400">Erro ao carregar coment√°rios.</p>`;
                }
            }

            function toggleReminder(eventId) {
                const reminderIndex = savedReminders.indexOf(eventId);
                if (reminderIndex > -1) {
                    savedReminders.splice(reminderIndex, 1);
                    if (currentUser) { removeUserReminder(currentUser.uid, eventId); }
                } else {
                    savedReminders.push(eventId);
                    if (currentUser) { saveUserReminder(currentUser.uid, eventId); }
                }
                localStorage.setItem('eventReminders', JSON.stringify(savedReminders));
                const openDate = detailsPanel.dataset.date;
                if (openDate) {
                    showDayDetails(openDate);
                }
            }
            
            function renderModalContent(container, lineupData, statsData, highlightsData, eventName) {
                let html = '';
                html += `<h4 class="text-lg font-bold text-white mb-3 border-b border-gray-600 pb-2">Escala√ß√µes</h4>`;
                const lineups = lineupData.lineup;
                if (lineups && lineups.length > 0) {
                    const homeTeam = lineups.filter(p => p.strTeam === 'Home');
                    const awayTeam = lineups.filter(p => p.strTeam === 'Away');
                    html += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-6 text-sm">`;
                    html += `<div><h5 class="font-semibold mb-2 text-indigo-300">${homeTeam[0]?.strHome || 'Time da Casa'}</h5><ul class="space-y-1">`;
                    homeTeam.forEach(player => { html += `<li class="text-gray-300">${player.strPlayer} <span class="text-gray-500">(${player.strPosition})</span></li>`; });
                    html += `</ul></div>`;
                    html += `<div><h5 class="font-semibold mb-2 text-indigo-300">${awayTeam[0]?.strAway || 'Time Visitante'}</h5><ul class="space-y-1">`;
                    awayTeam.forEach(player => { html += `<li class="text-gray-300">${player.strPlayer} <span class="text-gray-500">(${player.strPosition})</span></li>`; });
                    html += `</ul></div>`;
                    html += `</div>`;
                } else {
                    html += `<p class="text-gray-400 text-sm">Escala√ß√µes n√£o dispon√≠veis.</p>`;
                }
                html += `<h4 class="text-lg font-bold text-white mt-6 mb-3 border-b border-gray-600 pb-2">Estat√≠sticas</h4>`;
                const stats = statsData.eventstats;
                if (stats && stats.length > 0) {
                    html += `<ul class="space-y-2 text-sm">`;
                    stats.forEach(stat => {
                        html += `
                            <li class="flex justify-between items-center bg-gray-900 p-2 rounded-md">
                                <span class="font-bold text-lg w-1/4 text-left">${stat.intHome || 0}</span>
                                <span class="text-gray-400 text-center w-1/2">${stat.strStat}</span>
                                <span class="font-bold text-lg w-1/4 text-right">${stat.intAway || 0}</span>
                            </li>`;
                    });
                    html += `</ul>`;
                } else {
                    html += `<p class="text-gray-400 text-sm">Estat√≠sticas n√£o dispon√≠veis.</p>`;
                }
                html += `<h4 class="text-lg font-bold text-white mt-6 mb-3 border-b border-gray-600 pb-2">Destaques em V√≠deo</h4>`;
                const eventHighlight = highlightsData.tvhighlights?.find(h => h.strEvent === eventName);
if (eventHighlight && eventHighlight.strVideo) {
    const videoIdMatch = eventHighlight.strVideo.match(/(?:v=|\/embed\/|\.be\/)([a-zA-Z0-9_-]{11})/);
    if (videoIdMatch && videoIdMatch[1]) {
        const videoId = videoIdMatch[1];
        html += `
            <div id="resizable-video-container" class="relative w-full" style="height: 300px;">
                <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="rounded-lg w-full h-full"></iframe>
            </div>
            <div id="video-resize-handle" class="w-full h-4 mt-1 flex items-center justify-center cursor-ns-resize group">
                <div class="w-10 h-1 bg-gray-600 rounded-full group-hover:bg-indigo-400 transition-colors"></div>
            </div>`;
    } else {
                        html += `<a href="${eventHighlight.strVideo}" target="_blank" rel="noopener noreferrer" class="inline-block bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700 transition-colors">Assista no YouTube</a>`;
                    }
                } else {
                    html += `<p class="text-gray-400 text-sm">Nenhum destaque em v√≠deo encontrado para esta partida.</p>`;
                }
                container.innerHTML = html;
            }

            function createMatchTitleHTML(event) {
                const homeBadgeHTML = event.strHomeTeamBadge ? `<img src="${event.strHomeTeamBadge}" alt="${event.strHomeTeam}" class="team-badge">` : '';
                const awayBadgeHTML = event.strAwayTeamBadge ? `<img src="${event.strAwayTeamBadge}" alt="${event.strAwayTeam}" class="team-badge">` : '';
                
                return `
                    ${homeBadgeHTML}
                    <span>${event.strHomeTeam}</span>
                    <span class="mx-2 font-normal">vs</span>
                    <span>${event.strAwayTeam}</span>
                    ${awayBadgeHTML}
                `;
            }

            async function openMatchDetailsModal(event) {
                modalMatchTitle.innerHTML = createMatchTitleHTML(event);
                matchDetailsModalOverlay.classList.remove('hidden');
                setTimeout(() => matchDetailsModal.classList.add('open'), 10);
                modalMatchContent.innerHTML = `<div class="text-center p-8">Carregando detalhes da partida...</div>`;
                try {
                    const [lineupRes, statsRes, highlightsRes] = await Promise.all([
                        fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/lookuplineup.php?id=${event.idEvent}`),
                        fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/lookupeventstats.php?id=${event.idEvent}`),
                        fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/eventshighlights.php?d=${event.dateEvent}`)
                    ]);
                    const lineupData = await lineupRes.json();
                    const statsData = await statsRes.json();
                    const highlightsData = await highlightsRes.json();
                    renderModalContent(modalMatchContent, lineupData, statsData, highlightsData, event.strEvent);
                    const videoContainer = document.getElementById('resizable-video-container');
                    const resizeHandle = document.getElementById('video-resize-handle');
                    if (videoContainer && resizeHandle) {
                        const onMouseDown = (e) => {
                            e.preventDefault();
                            const startHeight = videoContainer.offsetHeight;
                            const startY = e.clientY;
                            document.body.style.userSelect = 'none';
                            const onMouseMove = (moveEvent) => {
                                const newHeight = startHeight + moveEvent.clientY - startY;
                                if (newHeight > 150) { 
                                    videoContainer.style.height = `${newHeight}px`;
                                }
                            };
                            const onMouseUp = () => {
                                document.body.style.userSelect = '';
                                window.removeEventListener('mousemove', onMouseMove);
                                window.removeEventListener('mouseup', onMouseUp);
                            };
                            window.addEventListener('mousemove', onMouseMove);
                            window.addEventListener('mouseup', onMouseUp);
                        };
                        resizeHandle.addEventListener('mousedown', onMouseDown);
                    }
                } catch (error) {
                    console.error('Error fetching match details:', error);
                    modalMatchContent.innerHTML = `<div class="text-center p-8 text-red-400">N√£o foi poss√≠vel carregar os detalhes. Verifique sua conex√£o e tente novamente.</div>`;
                }
            }
            
            function closeMatchDetailsModal() {
                 matchDetailsModal.classList.remove('open');
                 setTimeout(() => {
                    matchDetailsModalOverlay.classList.add('hidden');
                 }, 300);
            }

            function showDayDetails(dateStr) {
                detailsPanel.dataset.date = dateStr;
                const date = new Date(dateStr + 'T00:00:00');
                detailsTitle.textContent = `Eventos de ${date.toLocaleDateString('pt-BR', { timeZone: 'UTC', dateStyle: 'full' })}`;
                
                let eventsOnDay = (allEventsData[eventPeriod] || []).filter(e => e.dateEvent === dateStr);
                eventsOnDay.sort((a,b) => getEventScore(b) - getEventScore(a));
                
                detailsContent.innerHTML = '';
                
                if (eventsOnDay.length > 0) {
                    eventsOnDay.forEach(event => {
                        const sportName = getSportByLeagueId(event.idLeague);
                        const sportConfig = sportConfigs[sportName];
                        const isHotGame = topTeams.includes(event.strHomeTeam) && topTeams.includes(event.strAwayTeam);
                        const eventIsGaloGame = isGaloGame(event);
                        const isReminderSet = savedReminders.includes(event.idEvent);
                        
                        const finalBgImage = `url(${event.strThumb || sportConfig?.backgroundImage || ''})`;
                        const bgImageStyle = finalBgImage !== 'url()' ? `background-image: ${finalBgImage};` : '';
                        const timeDisplay = (event.strTime && event.strTime !== "00:00:00") ? event.strTime.substring(0, 5) : 'A definir';
                        
                        let specialClass = '';
                        if(eventIsGaloGame) specialClass = 'border-2 border-yellow-400';
                        else if(isHotGame) specialClass = 'border-2 border-red-500';

                        let iconsHTML = '';
                        if(eventIsGaloGame) iconsHTML += `<div class="p-1 bg-gray-900/50 rounded-full"><img src="${GALO_ICON_URL}" alt="Jogo do Galo" class="special-icon"></div>`;
                        if(isHotGame) iconsHTML += `<div class="p-1 bg-gray-900/50 rounded-full text-base">üî•</div>`;

                        const matchContainer = document.createElement('div');
                        matchContainer.className = 'mb-8';

                        const eventCardHtml = `
                            <div class="event-card-header relative bg-gray-700 p-4 rounded-lg overflow-hidden cursor-pointer ${specialClass}" style="${bgImageStyle} background-size: cover; background-position: center;">
                                <div class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-sm"></div>
                                <div class="relative z-10">
                                    <p class="text-sm text-indigo-400 font-semibold">${event.strLeague}</p>
                                    <div class="text-lg font-bold mt-1 text-white flex items-center justify-center">${createMatchTitleHTML(event)}</div>
                                    <p class="text-sm text-gray-300 mt-2">Hor√°rio: ${timeDisplay}</p>
                                    <p class="text-sm text-gray-300">Local: ${event.strVenue || 'A definir'}</p>
                                    <div class="absolute top-2 right-2 flex items-center gap-x-2 z-10">
                                        ${iconsHTML}
                                        <button class="reminder-bell ${isReminderSet ? 'active' : ''}" data-event-id="${event.idEvent}" title="Ativar/Desativar lembrete">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22a2.98 2.98 0 002.818-2H9.182A2.98 2.98 0 0012 22zm7-7v-5.273A6.994 6.994 0 0013 2.127V2a1 1 0 00-2 0v.127A6.994 6.994 0 005 9.727V15l-2 2v1h18v-1l-2-2z"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                        matchContainer.innerHTML = eventCardHtml;
                        matchContainer.querySelector('.event-card-header').addEventListener('click', (e) => {
                            if (!e.target.closest('.reminder-bell')) {
                                openMatchDetailsModal(event);
                            }
                        });
                        
                        const commentSectionForEvent = document.createElement('div');
                        commentSectionForEvent.className = 'mt-4 pt-4 border-t border-gray-700';
                        commentSectionForEvent.innerHTML = `
                            <div class="comments-toggle-button bg-gray-600 p-3 rounded-lg cursor-pointer flex justify-between items-center transition hover:bg-gray-500">
                                <span class="font-semibold text-white">Coment√°rios do Jogo</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="comments-collapsible-content mt-2">
                                <div id="comments-list-${event.idEvent}" class="space-y-3 mb-4 max-h-48 overflow-y-auto">
                                    <p class="text-gray-400 text-sm" id="no-comments-message-${event.idEvent}">Nenhum coment√°rio ainda.</p>
                                </div>
                                <div id="comment-input-area-${event.idEvent}" class="space-y-2">
                                    <textarea id="comment-text-${event.idEvent}" class="w-full bg-gray-700 border-gray-600 rounded-lg p-3 text-sm text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Escreva seu coment√°rio..."></textarea>
                                    <button id="save-comment-button-${event.idEvent}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">
                                        Salvar Coment√°rio
                                    </button>
                                </div>
                                <p id="comment-auth-message-${event.idEvent}" class="text-red-400 text-sm mt-2 hidden">Fa√ßa login para comentar.</p>
                            </div>`;
                        matchContainer.appendChild(commentSectionForEvent);
                        detailsContent.appendChild(matchContainer);
                        const commentsCollapsibleContent = commentSectionForEvent.querySelector('.comments-collapsible-content');
                        const commentsToggleButton = commentSectionForEvent.querySelector('.comments-toggle-button');
                        const toggleIcon = commentsToggleButton.querySelector('svg');

                        commentsToggleButton.addEventListener('click', () => {
                            commentsCollapsibleContent.classList.toggle('open');
                            toggleIcon.classList.toggle('rotate-180');
                        });
                        const commentsListForEvent = document.getElementById(`comments-list-${event.idEvent}`);
                        const noCommentsMessageForEvent = document.getElementById(`no-comments-message-${event.idEvent}`);
                        const commentInputAreaForEvent = document.getElementById(`comment-input-area-${event.idEvent}`);
                        const commentTextareaForEvent = document.getElementById(`comment-text-${event.idEvent}`);
                        const saveCommentButtonForEvent = document.getElementById(`save-comment-button-${event.idEvent}`);
                        const commentAuthMessageForEvent = document.getElementById(`comment-auth-message-${event.idEvent}`);
                        
                        if (currentUser) {
                            commentInputAreaForEvent.classList.remove('hidden');
                            commentAuthMessageForEvent.classList.add('hidden');
                            loadCommentsForEvent(event.idEvent, commentsListForEvent, noCommentsMessageForEvent);
                        } else {
                            commentInputAreaForEvent.classList.add('hidden');
                            commentAuthMessageForEvent.classList.remove('hidden');
                            commentsListForEvent.innerHTML = '';
                            noCommentsMessageForEvent.classList.remove('hidden');
                        }

                        saveCommentButtonForEvent.addEventListener('click', () => {
                            if (!currentUser) { alert('Voc√™ precisa estar logado para salvar coment√°rios.'); return; }
                            const commentText = commentTextareaForEvent.value.trim();
                            if (commentText.length === 0) { alert('O coment√°rio n√£o pode estar vazio.'); return; }
                            saveUserComment(currentUser.uid, currentUser.displayName, currentUser.photoURL, event.idEvent, commentText);
                        });
                    });
                } else {
                    detailsContent.innerHTML = '<p>Nenhum evento para este dia com os filtros atuais.</p>';
                }
                detailsPanel.classList.add('open');
                detailsContent.querySelectorAll('.reminder-bell').forEach(bell => {
                    bell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleReminder(e.currentTarget.dataset.eventId);
                    });
                });
                detailsPanel.classList.add('open');
                detailsContent.querySelectorAll('.reminder-bell').forEach(bell => {
                    bell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleReminder(e.currentTarget.dataset.eventId);
                    });
                });

                // ATIVE O ESCUTADOR DE CLIQUE FORA
                // Usamos um pequeno timeout para evitar que o mesmo clique que abre o painel o feche imediatamente
                setTimeout(() => {
                    document.addEventListener('mousedown', handleClickOutside, true);
                }, 0);
            }
            
            
            function getSportByLeagueId(leagueId) {
                for (const sportName in sportConfigs) {
                    if (sportConfigs[sportName].leagues) {
                        for (const leagueKey in sportConfigs[sportName].leagues) {
                            if (sportConfigs[sportName].leagues[leagueKey].id === leagueId) return sportName;
                        }
                    }
                }
                return null;
            }

            // --- AUTENTICA√á√ÉO FIREBASE ---
            loginButton.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Erro no login:", error);
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Erro ao sair:", error);
                }
            });

            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                if (user) {
                    userProfileArea.classList.remove('hidden');
                    loginButton.classList.add('hidden');
                    userPhoto.src = user.photoURL || 'https://via.placeholder.com/40/374151/FFFFFF?text=?';
                    userName.textContent = user.displayName || user.email;
                    loadUserReminders(user.uid);
                } else {
                    userProfileArea.classList.add('hidden');
                    loginButton.classList.remove('hidden');
                    userName.textContent = '';
                    userPhoto.src = '';
                    savedReminders = [];
                    applyFiltersAndRender();
                }
            });
            
            userPhoto.addEventListener('click', () => {
                userDropdown.classList.toggle('hidden');
                userDropdown.classList.toggle('opacity-0');
                userDropdown.classList.toggle('scale-95');
            });
            
            window.addEventListener('click', (e) => {
                if (!userProfileArea.contains(e.target)) {
                    userDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
                }
            });

            // --- INICIALIZA√á√ÉO E EVENT LISTENERS ---
            
            // ADICIONE ESTA NOVA FUN√á√ÉO AQUI
            function handleClickOutside(event) {
                // Seleciona o painel de detalhes
                const detailsPanel = document.getElementById('day-details-panel');
                
                // Verifica se o painel est√° aberto e se o alvo do clique N√ÉO est√° contido dentro do painel
                if (detailsPanel.classList.contains('open') && !detailsPanel.contains(event.target)) {
                    
                    // Impede que o clique se propague para outros elementos que possam abrir o painel novamente
                    event.stopPropagation();
                    event.preventDefault();

                    // Fecha o painel
                    detailsPanel.classList.remove('open');
                    
                    // IMPORTANTE: Remove o 'escutador' de eventos para limpar e evitar execu√ß√µes futuras
                    document.removeEventListener('mousedown', handleClickOutside, true);
                }
            }

            document.querySelectorAll('input[name="event-period"]').forEach(radio => {
                radio.addEventListener('change', (e) => { 
                    eventPeriod = e.target.value; 
                    currentDate = new Date(); 
                    currentWeekDate = new Date();
                    fetchAllEventsForPeriod(); 
                });
            });

            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 2); applyFiltersAndRender(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 2); applyFiltersAndRender(); });
            prevWeekBtn.addEventListener('click', () => { currentWeekDate.setDate(currentWeekDate.getDate() - 7); applyFiltersAndRender(); });
            nextWeekBtn.addEventListener('click', () => { currentWeekDate.setDate(currentWeekDate.getDate() + 7); applyFiltersAndRender(); });

            viewSwitcher.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const view = button.dataset.view;
                if (view === currentView) return;
                currentView = view;
                viewSwitcher.querySelector('.active').classList.remove('active');
                button.classList.add('active');
                applyFiltersAndRender();
            });

            closeDetailsBtn.addEventListener('click', () => {
                detailsPanel.classList.remove('open');
                document.removeEventListener('mousedown', handleClickOutside, true);
            });

            sidebarToggleBtn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            viewModeSelect.addEventListener('change', applyFiltersAndRender);
            hotGamesToggle.addEventListener('change', applyFiltersAndRender);
            galoOnlyToggle.addEventListener('change', applyFiltersAndRender);
            closeMatchModalBtn.addEventListener('click', closeMatchDetailsModal);
            matchDetailsModalOverlay.addEventListener('click', (e) => {
                if (e.target === matchDetailsModalOverlay) closeMatchDetailsModal();
            });
            
            teamSearchInput.addEventListener('input', () => {
                const inputValue = teamSearchInput.value.toLowerCase();
                autocompleteResults.innerHTML = '';
                const events = allEventsData[eventPeriod] || [];
                if (inputValue.length > 0) {
                    const teamNames = [...new Set(events.flatMap(ev => [ev.strHomeTeam, ev.strAwayTeam]).filter(Boolean))];
                    const suggestions = teamNames.filter(name => name.toLowerCase().startsWith(inputValue)).sort().slice(0, 7);
                    if (suggestions.length > 0) {
                        suggestions.forEach(name => {
                            const item = document.createElement('div');
                            item.className = 'p-3 cursor-pointer hover:bg-indigo-600';
                            item.textContent = name;
                            item.addEventListener('click', () => {
                                teamSearchInput.value = name;
                                autocompleteResults.classList.add('hidden');
                                if (viewModeSelect.value === 'todos') viewModeSelect.value = 'principais';
                                applyFiltersAndRender();
                            });
                            autocompleteResults.appendChild(item);
                        });
                        autocompleteResults.classList.remove('hidden');
                    } else {
                        autocompleteResults.classList.add('hidden');
                    }
                } else {
                    autocompleteResults.classList.add('hidden');
                }
                applyFiltersAndRender();
            });

            document.addEventListener('click', (e) => {
                if (!document.getElementById('team-search-container').contains(e.target)) {
                    autocompleteResults.classList.add('hidden');
                }
            });
            
            document.body.classList.add('loaded');
            populateFilters();
            const filterItems = document.querySelectorAll('.filter-item, .nav-item');
            filterItems.forEach((item, index) => {
                setTimeout(() => {
                    item.classList.add('visible');
                }, 100 + (index * 50));
            });

            loadParticles();
            await fetchAllEventsForPeriod();
        });
    </script>
</body>
</html>